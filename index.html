<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Alabanzas - Iglesia</title>

    <!-- Estilos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons for Sidebar -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=14">

    <!-- Scripts de la Aplicaci√≥n (Orden Importante) -->
    <script src="config.js?v=6"></script>
    <script src="ui.js?v=13"></script>
    <script src="api.js?v=6"></script>
    <script src="auth.js?v=9"></script>
    <script src="app.js?v=6"></script>

    <!-- Scripts de Google (Cargan al final y llaman a funciones definidas en auth.js) -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</head>

<body>
    <!-- PANTALLA SELECCI√ìN DE IGLESIA (Multi-Tenant) -->
    <div id="churchSelectionOverlay" class="role-selection-overlay" style="z-index: 2000;">
        <div class="role-selection-card">
            <div style="font-size: 3em; margin-bottom: 15px;">üèõÔ∏è</div>
            <h2 style="color: #2dd4bf; margin-bottom: 10px;">Configuraci√≥n Inicial</h2>
            <p style="color: #99f6e4; margin-bottom: 15px;">
                Para comenzar, necesitamos conectar con la base de datos de tu iglesia.
            </p>

            <div class="input-group" style="margin-bottom: 20px;">
                <label style="display:block; text-align:left; color:#ccfbf1; margin-bottom:8px;">ID de Google
                    Sheet</label>
                <input type="text" id="churchIdInput" placeholder="Ej: 1qBQRPiAomG1wVzIF4..."
                    style="width: 100%; text-align: center; font-size: 0.9em; padding: 12px; font-family: monospace;">
                <p style="font-size: 0.8em; color: #64748b; margin-top: 8px;">
                    Copia el ID largo que est√° en la URL de tu hoja de c√°lculo.
                </p>
            </div>

            <button id="joinChurchBtn" onclick="validateAndSaveChurch()"
                style="width: 100%; padding: 15px; font-size: 1.1em;" class="btn-success">
                üîó Conectar
            </button>

            <div style="margin-top: 20px; border-top: 1px solid #334155; padding-top: 15px;">
                <p style="color: #99f6e4; font-size: 0.9em; margin-bottom: 10px;">¬øEres nuevo? Crea tu base de datos en
                    1 click:</p>
                <button id="createChurchBtn" onclick="validateAndSaveChurch('AUTO')"
                    style="width: 100%; padding: 12px; font-size: 0.95em; background: #0f766e; background: #115e59; color: white;">
                    ‚ú® Crear Iglesia Autom√°ticamente
                </button>
                <p style="font-size: 0.75em; color: #64748b; margin-top: 8px;">
                    Se te pedir√° permiso para usar Google Drive una √∫nica vez.
                </p>

                <p style="color: #475569; font-size: 0.8em; margin-top: 15px; cursor:pointer; text-decoration:underline;"
                    onclick="window.open('https://docs.google.com/spreadsheets/d/1qBQRPiAomG1wVzIF4XmHMoDlPKXbVcrQKQD4JnXVdF0/copy', '_blank')">
                    O haz una copia manual (m√©todo antiguo)
                </p>
            </div>
        </div>
    </div>

    <!-- PANTALLA SELECCI√ìN DE ROL (primera vez) -->
    <div id="roleSelectionOverlay" class="role-selection-overlay">
        <div class="role-selection-card">
            <div style="font-size: 3em; margin-bottom: 15px;">üéµ</div>
            <h2 style="color: #2dd4bf; margin-bottom: 10px;">¬°Bienvenido al equipo!</h2>
            <p style="color: #99f6e4; margin-bottom: 10px;">Es tu primera vez aqu√≠. ¬øCu√°l es tu nombre?</p>
            <input type="text" id="newUserName" placeholder="Tu nombre (ej: Juan P√©rez)"
                style="width: 100%; margin-bottom: 20px; text-align: center; font-size: 1.1em;">
            <p style="color: #99f6e4; margin-bottom: 15px;">¬øCu√°l es tu rol en el equipo de alabanza?</p>

            <div class="role-option" onclick="selectRole('lider')" id="roleOptLider">
                <div class="role-option-title">üëë L√≠der de Alabanza</div>
                <div class="role-option-desc">Administra el repertorio, ensayos, servicios y m√∫sicos. Acceso completo.
                </div>
            </div>
            <div class="role-option" onclick="selectRole('musico')" id="roleOptMusico">
                <div class="role-option-title">üé∏ M√∫sico</div>
                <div class="role-option-desc">Ve el repertorio, sugiere canciones y confirma asistencia a ensayos.</div>
            </div>
            <div class="role-option" onclick="selectRole('invitado')" id="roleOptInvitado">
                <div class="role-option-title">üå± Invitado</div>
                <div class="role-option-desc">Solo lectura. Ve el repertorio, pr√≥ximos ensayos y setlist del domingo. No
                    puede sugerir ni editar nada.</div>
            </div>

            <div id="roleWarning"
                style="display:none; background: #7c2d12; border-radius: 8px; padding: 12px; margin: 15px 0; color: #fdba74; font-size: 0.9em;">
                ‚ö†Ô∏è Ya existe un L√≠der en el equipo. Solo puede haber uno. Por favor selecciona M√∫sico.
            </div>

            <button id="confirmRoleBtn" onclick="confirmRole()"
                style="width: 100%; margin-top: 15px; padding: 15px; font-size: 1.1em;" disabled>
                ‚úÖ Unirme al equipo
            </button>
        </div>
    </div>

    <!-- PANTALLA DE CARGA (Overlay) -->
    <!-- PANTALLA DE CARGA (Overlay) -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div id="loadingSpinner" class="spinner"></div>
            <h2 id="loadingText">Iniciando sesi√≥n con Google...</h2>
            <p id="loadingSubtext" style="color: #99f6e4; margin-top: 10px;">Por favor autoriza el acceso</p>

            <div id="manualLoginContainer" style="display:none; margin-top: 20px;">
                <p style="margin-bottom: 15px; color: #fca5a5;">‚ö†Ô∏è El navegador bloque√≥ la ventana emergente.</p>

                <!-- Container para bot√≥n renderizado por JS -->
                <div id="googleBtnContainer" style="display: flex; justify-content: center; margin-bottom: 15px;"></div>

                <button onclick="handleAuthClick()"
                    style="width: 100%; padding: 12px 20px; background: #0f766e; color: white; border:none; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid rgba(255,255,255,0.2);">
                    Intentar de nuevo manualmente
                </button>
            </div>

            <!-- Failsafe Script -->
            <script>
                setTimeout(() => {
                    const spinner = document.getElementById('loadingSpinner');
                    const manualContainer = document.getElementById('manualLoginContainer');
                    const loadingText = document.getElementById('loadingText');

                    // Si el contenedor manual sigue oculto y seguimos en el overlay
                    if (manualContainer && manualContainer.style.display === 'none') {
                        console.warn("Failsafe triggers: showing manual login");
                        if (spinner) spinner.style.display = 'none';
                        if (loadingText) loadingText.textContent = '¬øProblemas de conexi√≥n?';
                        if (manualContainer) manualContainer.style.display = 'block';
                    }
                }, 5000); // 5 segundos de espera m√°xima absoluta
            </script>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">

        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="material-icons-round">temple_hindu</span>
            </div>

            <nav class="nav-menu">
                <!-- Repertorio (Home/Library) -->
                <div class="nav-item active" data-tab="repertorio" data-title="Repertorio">
                    <span class="material-icons-round">library_music</span>
                </div>

                <!-- Domingo Actual (Services) -->
                <div class="nav-item" data-tab="domingo" data-title="Domingo Actual">
                    <span class="material-icons-round">event_available</span>
                </div>

                <!-- Ensayos (Rehearsals) -->
                <div class="nav-item" data-tab="ensayos" data-title="Ensayos">
                    <span class="material-icons-round">groups</span>
                </div>

                <!-- Pendientes (Pending) -->
                <div class="nav-item" data-tab="pendientes" data-title="Pendientes">
                    <span class="material-icons-round">hourglass_empty</span>
                </div>

                <!-- Historial (History) -->
                <div class="nav-item" data-tab="historial" data-title="Historial">
                    <span class="material-icons-round">history</span>
                </div>
            </nav>

            <div class="mt-auto"
                style="margin-top: auto; width: 100%; display: flex; justify-content: center; padding-bottom: 20px;">
                <!-- Configuraci√≥n (Settings) -->
                <div class="nav-item" data-tab="configuracion" data-title="Configuraci√≥n">
                    <span class="material-icons-round">settings</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent" style="display:none;"> <!-- Oculto por defecto hasta login -->
            <!-- Header -->
            <header class="app-header">
                <div class="page-title">
                    <h1 id="pageTitle">Repertorio</h1>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="userInfoDisplay" style="font-size: 0.9em; color: var(--text-muted);"></div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="content-scroll">

                <!-- VISTAS / CONTENIDO -->

                <!-- VISTA REPERTORIO -->
                <div id="repertorioTab" class="tab-content active">
                    <div class="action-bar" style="margin-bottom: 20px;">
                        <input type="text" id="searchInput" placeholder="Buscar alabanza..." class="search-input"
                            onkeyup="filterSongs()">
                        <button id="addSongBtn" class="btn-primary" onclick="showAddSongModal()" style="display: none;">
                            <i class="fas fa-plus"></i> Nueva
                        </button>
                    </div>
                    <div id="songList" class="song-grid">
                        <!-- Se llena con JS -->
                    </div>
                </div>

                <!-- VISTA DOMINGO -->
                <div id="domingoTab" class="tab-content">
                    <div class="glass-card" style="padding: 20px; margin-bottom: 20px;">
                        <h2 class="text-glow" style="margin-bottom: 15px;">Pr√≥ximo Domingo</h2>

                        <div id="sundayServiceInfo">
                            <!-- Info del servicio -->
                        </div>

                        <div id="sundaySongList" class="song-list-simple">
                            <!-- Lista de canciones del domingo -->
                        </div>

                        <div id="sundayAdminControls"
                            style="margin-top: 20px; display:none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">Gesti√≥n (L√≠der)</h3>
                            <button onclick="clearSundayList()" class="btn-danger btn-small">Limpiar Lista</button>
                            <button onclick="finalizeSunday()" class="btn-success btn-small"
                                title="Mover al historial">Finalizar Domingo</button>
                        </div>
                    </div>

                    <!-- Selector para agregar canciones al domingo -->
                    <div id="sundaySelectorArea" style="display:none;" class="glass-card p-5">
                        <h3>Agregar al Domingo</h3>
                        <select id="sundaySongSelector"
                            style="width: 100%; padding: 10px; margin: 10px 0; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                            <!-- Se llena con JS -->
                        </select>
                        <button onclick="addSongToSunday()" class="btn-primary" style="width: 100%;">Agregar</button>
                    </div>
                </div>

                <!-- VISTA ENSAYOS -->
                <div id="ensayosTab" class="tab-content">
                    <div class="glass-card" style="padding: 20px;">
                        <h2 class="text-glow">Gesti√≥n de Ensayos</h2>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">Confirma tu asistencia a los
                            pr√≥ximos
                            ensayos.</p>

                        <div id="rehearsalList">
                            <!-- Lista de ensayos -->
                        </div>

                        <div id="rehearsalHistoryList" style="margin-top: 30px;">
                            <!-- Historial de ensayos pasados/futuros -->
                        </div>
                    </div>

                    <div id="rehearsalAdminPanel" style="display:none; margin-top: 20px;" class="glass-card p-5">
                        <h3>Programar Nuevo Ensayo</h3>
                        <input type="datetime-local" id="newRehearsalDate"
                            style="width: 100%; padding: 10px; margin: 10px 0; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                        <button onclick="createRehearsal()" class="btn-primary" style="width: 100%;">Crear
                            Ensayo</button>
                    </div>
                </div>

                <!-- VISTA PENDIENTES -->
                <div id="pendientesTab" class="tab-content">
                    <div class="glass-card" style="padding: 20px;">
                        <h2 class="text-glow">Sugerencias y Pendientes</h2>
                        <div id="pendingList" class="song-list"></div>
                    </div>
                    <div id="suggestionBox" style="margin-top: 20px;" class="glass-card p-5">
                        <h3>Sugerir Alabanza</h3>
                        <input type="text" id="suggestionInput" placeholder="Nombre de la alabanza..."
                            style="width: 100%; padding: 10px; margin: 10px 0; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                        <button onclick="submitSuggestion()" class="btn-primary" style="width: 100%;">Sugerir</button>
                    </div>
                </div>

                <!-- VISTA HISTORIAL -->
                <div id="historialTab" class="tab-content">
                    <div class="glass-card" style="padding: 20px;">
                        <h2 class="text-glow">Historial de Servicios</h2>
                        <div id="historyList" style="margin-top: 15px;">
                            <!-- Historial -->
                        </div>
                    </div>
                </div>

                <!-- VISTA CONFIGURACI√ìN -->
                <div id="configuracionTab" class="tab-content">
                    <div class="glass-card" style="padding: 20px;">
                        <h2 class="text-glow">Configuraci√≥n</h2>

                        <div style="margin-top: 20px;">
                            <h3>Mi Perfil</h3>
                            <p id="configUserName" style="color: var(--text-muted);"></p>
                            <p id="configUserRole" style="color: var(--primary); font-weight: bold;"></p>
                        </div>

                        <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                            <h3>Iglesia Conectada</h3>
                            <p style="font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; word-break: break-all;"
                                id="currentSpreadsheetId"></p>
                            <button onclick="switchChurch()" class="btn-danger-outline"
                                style="margin-top: 10px;">Desconectar / Cambiar Iglesia</button>
                        </div>

                        <div id="adminConfigPanel"
                            style="display:none; margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                            <h3 style="color: var(--role-lider);">Panel de L√≠der</h3>
                            <p style="font-size: 0.9em; color: var(--text-muted);">Gesti√≥n avanzada de miembros.</p>

                            <div style="margin-top: 15px;">
                                <button onclick="resetUsers()" class="btn-danger">‚ö†Ô∏è Resetear Miembros</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- End Content Scroll -->
        </main> <!-- End Main Content -->
    </div> <!-- End App Container -->

    <!-- Toast Notification -->
    <div id="toast" class="toast">Mensaje</div>

    <!-- Modal Agregar/Editar Canci√≥n -->
    <div id="songModal" class="modal">
        <div class="modal-content glass-card">
            <span class="close" onclick="closeSongModal()">&times;</span>
            <h2 id="modalTitle" class="text-glow">Nueva Alabanza</h2>
            <form id="songForm">
                <input type="hidden" id="songId">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="songName" required>
                </div>
                <!-- ... Otros campos del formulario ... -->
                <!-- Simplificado para el ejemplo, se puede expandir seg√∫n ui.js original -->
                <div class="form-group">
                    <label>Tonalidad</label>
                    <input type="text" id="songKey">
                </div>
                <div class="form-group">
                    <label>BPM</label>
                    <input type="number" id="songBpm">
                </div>
                <div class="form-group">
                    <label>Dificultad</label>
                    <select id="songDifficulty">
                        <option value="Baja">Baja</option>
                        <option value="Media">Media</option>
                        <option value="Alta">Alta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Link YouTube</label>
                    <input type="url" id="songYoutube">
                </div>
                <div class="form-group">
                    <label>Link PDF/Acordes</label>
                    <input type="url" id="songPdf">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeSongModal()">Cancelar</button>
                    <button type="submit" class="btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

</body>

</html>