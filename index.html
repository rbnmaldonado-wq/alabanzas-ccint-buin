<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Alabanzas - Iglesia</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="styles.css">

    <!-- Scripts de la AplicaciÃ³n (Orden Importante) -->
    <script src="config.js"></script>
    <script src="ui.js"></script>
    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script src="app.js"></script>

    <!-- Scripts de Google (Cargan al final y llaman a funciones definidas en auth.js) -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</head>

<body>
    <!-- PANTALLA SELECCIÃ“N DE IGLESIA (Multi-Tenant) -->
    <div id="churchSelectionOverlay" class="role-selection-overlay" style="z-index: 2000;">
        <div class="role-selection-card">
            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ›ï¸</div>
            <h2 style="color: #60a5fa; margin-bottom: 10px;">ConfiguraciÃ³n Inicial</h2>
            <p style="color: #94a3b8; margin-bottom: 15px;">
                Para comenzar, necesitamos conectar con la base de datos de tu iglesia.
            </p>

            <div class="input-group" style="margin-bottom: 20px;">
                <label style="display:block; text-align:left; color:#dbeafe; margin-bottom:8px;">ID de Google
                    Sheet</label>
                <input type="text" id="churchIdInput" placeholder="Ej: 1qBQRPiAomG1wVzIF4..."
                    style="width: 100%; text-align: center; font-size: 0.9em; padding: 12px; font-family: monospace;">
                <p style="font-size: 0.8em; color: #64748b; margin-top: 8px;">
                    Copia el ID largo que estÃ¡ en la URL de tu hoja de cÃ¡lculo.
                </p>
            </div>

            <button id="joinChurchBtn" onclick="validateAndSaveChurch()"
                style="width: 100%; padding: 15px; font-size: 1.1em;" class="btn-success">
                ğŸ”— Conectar
            </button>

            <div style="margin-top: 20px; border-top: 1px solid #334155; padding-top: 15px;">
                <p style="color: #94a3b8; font-size: 0.9em; margin-bottom: 10px;">Â¿No tienes una hoja de cÃ¡lculo aÃºn?
                </p>
                <button
                    onclick="window.open('https://docs.google.com/spreadsheets/d/1qBQRPiAomG1wVzIF4XmHMoDlPKXbVcrQKQD4JnXVdF0/copy', '_blank')"
                    style="width: 100%; padding: 10px; font-size: 0.9em; background: #0f766e; border: 1px solid #115e59; color: white;">
                    ğŸ“‘ Copiar Plantilla Oficial
                </button>
            </div>
        </div>
    </div>

    <!-- PANTALLA SELECCIÃ“N DE ROL (primera vez) -->
    <div id="roleSelectionOverlay" class="role-selection-overlay">
        <div class="role-selection-card">
            <div style="font-size: 3em; margin-bottom: 15px;">ğŸµ</div>
            <h2 style="color: #60a5fa; margin-bottom: 10px;">Â¡Bienvenido al equipo!</h2>
            <p style="color: #94a3b8; margin-bottom: 10px;">Es tu primera vez aquÃ­. Â¿CuÃ¡l es tu nombre?</p>
            <input type="text" id="newUserName" placeholder="Tu nombre (ej: Juan PÃ©rez)"
                style="width: 100%; margin-bottom: 20px; text-align: center; font-size: 1.1em;">
            <p style="color: #94a3b8; margin-bottom: 15px;">Â¿CuÃ¡l es tu rol en el equipo de alabanza?</p>

            <div class="role-option" onclick="selectRole('lider')" id="roleOptLider">
                <div class="role-option-title">ğŸ‘‘ LÃ­der de Alabanza</div>
                <div class="role-option-desc">Administra el repertorio, ensayos, servicios y mÃºsicos. Acceso completo.
                </div>
            </div>
            <div class="role-option" onclick="selectRole('musico')" id="roleOptMusico">
                <div class="role-option-title">ğŸ¸ MÃºsico</div>
                <div class="role-option-desc">Ve el repertorio, sugiere canciones y confirma asistencia a ensayos.</div>
            </div>
            <div class="role-option" onclick="selectRole('invitado')" id="roleOptInvitado">
                <div class="role-option-title">ğŸŒ± Invitado</div>
                <div class="role-option-desc">Solo lectura. Ve el repertorio, prÃ³ximos ensayos y setlist del domingo. No
                    puede sugerir ni editar nada.</div>
            </div>

            <div id="roleWarning"
                style="display:none; background: #7c2d12; border-radius: 8px; padding: 12px; margin: 15px 0; color: #fed7aa; font-size: 0.9em;">
                âš ï¸ Ya existe un LÃ­der en el equipo. Solo puede haber uno. Por favor selecciona MÃºsico.
            </div>

            <button id="confirmRoleBtn" onclick="confirmRole()"
                style="width: 100%; margin-top: 15px; padding: 15px; font-size: 1.1em;" disabled>
                âœ… Unirme al equipo
            </button>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2 id="loadingText">Iniciando sesiÃ³n con Google...</h2>
            <p style="color: #94a3b8; margin-top: 10px;">Por favor autoriza el acceso</p>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <header>
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">?</div>
                <div>
                    <div class="user-name" id="userDisplayName">Cargando...</div>
                    <div id="userRoleBadge"></div>
                </div>
            </div>

            <div class="header-center">
                <div class="header-title-row">
                    <div id="churchLogoWrapper" style="display:none;">
                        <img id="churchLogo" src="" alt="Logo Iglesia" class="church-logo-img">
                    </div>
                    <div>
                        <h1>ğŸµ Gestor de Alabanzas</h1>
                        <p class="subtitle">Sistema musical de Iglesia CCINT Buin - SINCRONIZADO</p>
                    </div>
                </div>
            </div>

            <div id="syncIndicator" class="sync-indicator offline">
                <span class="sync-dot"></span>
                <span id="syncText">No conectado</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('repertorio')">ğŸ“š Repertorio</button>
            <button class="tab-button" id="tabDomingo" onclick="showTab('domingo')">ğŸ¤ Domingo Actual</button>
            <button class="tab-button" id="tabEnsayosAdmin" onclick="showTab('ensayos')">ğŸ“ Ensayos</button>
            <button class="tab-button" onclick="showTab('pendientes')">â³ Pendientes</button>
            <button class="tab-button" onclick="showTab('historial')">ğŸ“… Historial</button>
            <button class="tab-button lider-only" id="tabConfig" onclick="showTab('configuracion')">âš™ï¸
                ConfiguraciÃ³n</button>
        </div>

        <!-- TAB: REPERTORIO -->
        <div id="repertorio" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalSongs">0</div>
                    <div class="stat-label">Alabanzas en repertorio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSundays">0</div>
                    <div class="stat-label">Domingos registrados</div>
                </div>
            </div>

            <div class="card lider-only">
                <h2>â• Agregar Nueva Alabanza</h2>
                <div class="input-group">
                    <input type="text" id="songName" placeholder="Nombre de la alabanza">
                    <select id="songDifficulty">
                        <option value="">Nivel de dificultad</option>
                        <option value="FÃ¡cil">FÃ¡cil</option>
                        <option value="Media">Media</option>
                        <option value="DifÃ­cil">DifÃ­cil</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="text" id="songYouTube" placeholder="Link de YouTube (opcional)">
                    <input type="text" id="songPDF"
                        placeholder="Link del PDF con acordes (Google Drive, Dropbox, etc.)">
                </div>
                <button onclick="addSong()">Agregar</button>
            </div>

            <div class="card">
                <h2>ğŸ¸ Todas las Alabanzas</h2>
                <div id="songsList" class="song-list"></div>
            </div>
        </div>

        <!-- TAB: DOMINGO ACTUAL -->
        <div id="domingo" class="tab-content">
            <div class="card">
                <h2>ğŸ“… Seleccionar Fecha del Domingo</h2>
                <div class="input-group">
                    <div class="date-picker-wrapper">
                        <span class="date-icon">ğŸ“…</span>
                        <input type="date" id="sundayDate">
                    </div>
                    <button onclick="setSundayDate()">Establecer Fecha</button>
                </div>
                <p id="currentSundayDisplay" style="margin-top: 15px; color: #60a5fa; font-size: 1.1em;"></p>
            </div>

            <div id="repetitionWarning"></div>

            <div class="card">
                <h2>ğŸµ Seleccionar Alabanzas para este Domingo</h2>
                <p style="margin-bottom: 15px; color: #94a3b8;">Selecciona 4-5 alabanzas para el servicio</p>
                <div class="input-group">
                    <select id="songSelector">
                        <option value="">Selecciona una alabanza...</option>
                    </select>
                    <button onclick="addToSunday()">Agregar al Domingo</button>
                </div>

                <div id="sundayList" class="sunday-selector"></div>

                <button onclick="saveSunday()" style="margin-top: 20px; width: 100%;" class="btn-success">
                    ğŸ’¾ Guardar Domingo Completo
                </button>
            </div>
        </div>

        <!-- TAB: ENSAYOS -->
        <div id="ensayos" class="tab-content">
            <div class="card">
                <h2>ğŸ“ Planificar Ensayo</h2>
                <div class="input-group">
                    <div class="date-picker-wrapper">
                        <span class="date-icon">ğŸ“…</span>
                        <input type="date" id="rehearsalDate">
                    </div>
                    <div class="date-picker-wrapper">
                        <span class="date-icon">â°</span>
                        <input type="time" id="rehearsalTime" value="19:00">
                    </div>
                    <button onclick="setRehearsalDate()">Establecer Fecha y Hora</button>
                </div>
                <p id="currentRehearsalDisplay" style="margin-top: 15px; color: #60a5fa; font-size: 1.1em;"></p>
            </div>

            <div class="card">
                <h2>ğŸµ Alabanzas para Practicar</h2>
                <p style="margin-bottom: 15px; color: #94a3b8;">Selecciona las alabanzas que practicarÃ¡n en este ensayo
                </p>
                <div class="input-group">
                    <select id="rehearsalSongSelector">
                        <option value="">Selecciona una alabanza...</option>
                    </select>
                    <button onclick="addToRehearsal()">Agregar al Ensayo</button>
                </div>

                <div id="rehearsalList" class="sunday-selector"></div>

                <div class="input-group" style="margin-top: 20px;">
                    <textarea id="rehearsalNotes"
                        placeholder="Notas del ensayo (ej: enfocarse en el puente, practicar cambios de tempo, etc.)"
                        style="width: 100%; min-height: 80px; padding: 12px; background: #0f172a; border: 2px solid #334155; 
                                     border-radius: 8px; color: #e2e8f0; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <button onclick="saveRehearsal()" style="margin-top: 20px; width: 100%;" class="btn-success">
                    ğŸ’¾ Guardar Ensayo
                </button>
            </div>

            <div class="card">
                <h2>ğŸ“‹ PrÃ³ximos Ensayos y Historial</h2>
                <div id="rehearsalHistoryList"></div>
            </div>
        </div>

        <!-- TAB: PENDIENTES -->
        <div id="pendientes" class="tab-content">

            <div id="invitadoPendientesMsg" style="display:none;" class="card" style="text-align:center;">
                <div style="font-size:2em; margin-bottom:10px;">ğŸŒ±</div>
                <p style="color:#94a3b8;">Como <strong>Invitado</strong> puedes ver las alabanzas sugeridas, pero no
                    puedes agregar sugerencias. Habla con el LÃ­der para cambiar tu rol a MÃºsico.</p>
            </div>

            <div class="card musico-only">
                <h2>â³ Sugerir Nueva Alabanza para Aprender</h2>
                <div class="input-group">
                    <input type="text" id="pendingSongName" placeholder="Nombre de la alabanza">
                    <input type="text" id="suggestedBy" placeholder="Tu nombre (opcional)">
                    <select id="pendingPriority">
                        <option value="">Prioridad</option>
                        <option value="Alta">Alta - La necesitamos pronto</option>
                        <option value="Media">Media - Cuando podamos</option>
                        <option value="Baja">Baja - Sin apuro</option>
                    </select>
                    <button onclick="addPendingSong()">ğŸ“ Sugerir</button>
                </div>
                <div class="input-group">
                    <textarea id="pendingNotes"
                        placeholder="Notas adicionales (Â¿Por quÃ© esta alabanza? Â¿Link de YouTube?)"
                        style="width: 100%; min-height: 80px; padding: 12px; background: #0f172a; border: 2px solid #334155; 
                                     border-radius: 8px; color: #e2e8f0; font-family: inherit; resize: vertical;"></textarea>
                </div>
            </div>

            <div class="card">
                <h2>ğŸµ Alabanzas Pendientes por Aprender</h2>
                <div id="pendingSongsList" class="song-list"></div>
            </div>

            <div class="card">
                <h2>âœ… Alabanzas Aprendidas (Movidas al Repertorio)</h2>
                <div id="learnedSongsList" class="song-list"></div>
            </div>

            <div class="card" style="border-left: 4px solid #f43f5e;">
                <h2>âš ï¸ Zona de Peligro</h2>
                <p style="color:#dbeafe; margin-bottom: 15px;">
                    Si cambias de iglesia, se desconectarÃ¡ la hoja de cÃ¡lculo actual.
                </p>
                <button onclick="switchChurch()"
                    style="width:100%; background: #be123c; color: white; margin-bottom: 15px;">
                    ğŸ”„ Cambiar de Iglesia (Desconectar)
                </button>

                <p style="color:#dbeafe; margin-bottom: 15px; border-top: 1px solid #be123c; padding-top: 15px;">
                    Si el lÃ­der dejÃ³ el equipo o necesitas reiniciar los roles:
                </p>
                <button onclick="resetUsers()" style="width:100%; background: #7f1d1d; color: white;">
                    â˜¢ï¸ Resetear Todos los Usuarios
                </button>
            </div>
        </div>

        <!-- TAB: HISTORIAL -->
        <div id="historial" class="tab-content">
            <div class="card">
                <h2>ğŸ“œ Historial de Domingos (Ãšltimas 4 semanas)</h2>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- TAB: CONFIGURACIÃ“N (solo LÃ­der) -->
        <div id="configuracion" class="tab-content">

            <div class="card">
                <h2>âš™ï¸ ConfiguraciÃ³n General</h2>
                <p style="color:#94a3b8; margin-bottom: 20px;">Personaliza la app para que hable el idioma de tu
                    congregaciÃ³n.</p>

                <div style="margin-bottom: 20px;">
                    <label style="display:block; color:#60a5fa; font-weight:700; margin-bottom:8px;">ğŸ›ï¸ Nombre de la
                        Iglesia</label>
                    <input type="text" id="configChurchName" placeholder="Ej: CCINT Buin, Iglesia Central...">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display:block; color:#60a5fa; font-weight:700; margin-bottom:8px;">ğŸ–¼ï¸ Logo de la
                        Iglesia</label>
                    <p style="color:#94a3b8; font-size:0.9em; margin-bottom:12px;">Imagen pequeÃ±a (PNG o JPG
                        recomendado, mÃ¡x. 200KB). Se muestra circular en el banner.</p>
                    <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap;">
                        <div id="logoPreviewWrapper" style="width:64px; height:64px; border-radius:50%; border:2px dashed #334155;
                                                            background:#0f172a; display:flex; align-items:center; justify-content:center;
                                                            overflow:hidden; flex-shrink:0;">
                            <img id="logoPreviewImg" src="" alt=""
                                style="display:none; width:100%; height:100%; object-fit:cover;">
                            <span id="logoPreviewPlaceholder" style="font-size:1.8em;">ğŸ›ï¸</span>
                        </div>
                        <div style="flex:1;">
                            <input type="file" id="logoFileInput" accept="image/*" style="display:none;"
                                onchange="handleLogoUpload(event)">
                            <button onclick="document.getElementById('logoFileInput').click()"
                                style="margin-bottom:8px; background:#1e40af; width:100%;">
                                ğŸ“ Seleccionar imagen
                            </button>
                            <button onclick="removeLogo()"
                                style="background:#7f1d1d; width:100%; font-size:0.9em; padding:8px;">
                                ğŸ—‘ï¸ Quitar logo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ­ Nombres y Ãconos de Roles</h2>
                <p style="color:#94a3b8; margin-bottom: 20px;">Cambia cÃ³mo se llama cada rol para que suene natural en
                    tu ministerio.</p>

                <!-- ROL LÃDER -->
                <div
                    style="background:#0f172a; border-radius:12px; padding:20px; margin-bottom:15px; border-left: 4px solid #7c3aed;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        <div id="previewLiderIcon" style="font-size:2em;">ğŸ‘‘</div>
                        <div>
                            <div style="font-weight:700; color:#dbeafe;" id="previewLiderName">LÃ­der</div>
                            <div style="font-size:0.85em; color:#94a3b8;">Acceso completo</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="configLiderIcon" placeholder="Ãcono (ej: ğŸ‘‘ ğŸ¯ ğŸŒŸ âœï¸)" maxlength="4"
                            style="max-width:100px; text-align:center; font-size:1.5em;">
                        <input type="text" id="configLiderName"
                            placeholder="Nombre del rol (ej: Director, Pastor de AdoraciÃ³n)">
                    </div>
                </div>

                <!-- ROL MÃšSICO -->
                <div
                    style="background:#0f172a; border-radius:12px; padding:20px; margin-bottom:15px; border-left: 4px solid #0369a1;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        <div id="previewMusicoIcon" style="font-size:2em;">ğŸ¸</div>
                        <div>
                            <div style="font-weight:700; color:#dbeafe;" id="previewMusicoName">MÃºsico</div>
                            <div style="font-size:0.85em; color:#94a3b8;">Puede sugerir canciones</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="configMusicoIcon" placeholder="Ãcono (ej: ğŸ¸ ğŸ¹ ğŸº ğŸ»)" maxlength="4"
                            style="max-width:100px; text-align:center; font-size:1.5em;">
                        <input type="text" id="configMusicoName"
                            placeholder="Nombre del rol (ej: MÃºsico, Siervo, Integrante)">
                    </div>
                </div>

                <!-- ROL INVITADO -->
                <div
                    style="background:#0f172a; border-radius:12px; padding:20px; margin-bottom:20px; border-left: 4px solid #166534;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        <div id="previewInvitadoIcon" style="font-size:2em;">ğŸŒ±</div>
                        <div>
                            <div style="font-weight:700; color:#dbeafe;" id="previewInvitadoName">Invitado</div>
                            <div style="font-size:0.85em; color:#94a3b8;">Solo lectura</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="configInvitadoIcon" placeholder="Ãcono (ej: ğŸŒ± ğŸ•Šï¸ ğŸ™ âœ¨)" maxlength="4"
                            style="max-width:100px; text-align:center; font-size:1.5em;">
                        <input type="text" id="configInvitadoName"
                            placeholder="Nombre del rol (ej: Invitado, MÃºsico Nuevo, Visitante)">
                    </div>
                </div>

                <button onclick="saveConfig()" style="width:100%;" class="btn-success">
                    ğŸ’¾ Guardar ConfiguraciÃ³n
                </button>
            </div>

            <div class="card">
                <h2>ğŸ‘¥ Miembros del Equipo</h2>
                <p style="color:#94a3b8; margin-bottom: 15px;">Gestiona los mÃºsicos registrados en la app.</p>
                <div id="usersList"></div>
            </div>

        </div>
    </div>
</body>

</html>